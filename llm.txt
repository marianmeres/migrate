# @marianmeres/migrate - LLM Context File

## Package Overview

A general-purpose extensible versioning framework for managing incremental, bi-directional changes. Works with Deno and Node.js.

**Package:** @marianmeres/migrate
**Version:** 1.1.0
**Author:** Marian Meres
**License:** MIT
**Repository:** https://github.com/marianmeres/migrate
**NPM:** https://www.npmjs.com/package/@marianmeres/migrate
**JSR:** https://jsr.io/@marianmeres/migrate

## Use Cases

- Database migrations
- Undo/redo systems
- Progress change tracking
- Install/uninstall systems

## Architecture

### Core Classes

#### `Migrate` (src/migrate.ts)
The main migration manager class.

**Constructor:**
```typescript
new Migrate(options?: Partial<MigrateOptions>, context?: Record<string, any>)
```

**MigrateOptions:**
- `getActiveVersion: (context) => Promise<string | undefined>` - Reader for current version (e.g., from database)
- `setActiveVersion: (version, context) => Promise<string | undefined>` - Writer for current version
- `logger?: (...args: unknown[]) => void` - Optional debug logger

**Key Methods:**
- `addVersion(version, up, down, comment?)` - Register a new version with migration functions
- `getActiveVersion()` - Get currently active version
- `setActiveVersion(version)` - Set active version ("latest", "initial", or specific version)
- `up(target)` - Upgrade to target ("latest", "major", "minor", "patch", or specific version)
- `down(target)` - Downgrade to target ("initial", "major", "minor", "patch", or specific version)
- `uninstall()` - Complete removal (downgrades past initial version)
- `findVersion(version, assert?)` - Find a version instance
- `indexOf(version)` - Get index of a version

**Properties:**
- `versions` - Array of all Version instances
- `available` - Array of version strings
- `context` - The context object passed to migrations
- `compareFn` - The semver comparison function

#### `Version` (src/migrate.ts)
Represents a single version with its migration functions.

**Constructor:**
```typescript
new Version(version: string, up: MigrateFn, down: MigrateFn, comment?: string, logger?: Function)
```

**Properties:**
- `version` - Normalized semver string
- `major`, `minor`, `patch` - Parsed version segments
- `prerelease`, `build` - Semver prerelease and build metadata
- `comment` - Optional description

**Methods:**
- `up(context)` - Execute upgrade function
- `down(context)` - Execute downgrade function
- `toString()` - Returns normalized version string

### Semver Utilities (src/semver.ts)

- `normalizeSemver(version, assert?)` - Normalize version to MAJOR.MINOR.PATCH format
  - Accepts: "v1", "1.2", "1.2.3-alpha+build", etc.
  - Returns: "1.0.0", "1.2.0", "1.2.3-alpha+build", etc.
- `parseSemver(version)` - Parse into { major, minor, patch, prerelease, build }
- `compareSemver(a, b)` - Compare two versions (returns negative, 0, or positive)

## File Structure

```
src/
  mod.ts          # Main exports (re-exports migrate.ts and semver.ts)
  migrate.ts      # Migrate and Version classes
  semver.ts       # Semver utilities (normalize, parse, compare)

tests/
  migrate.test.ts # Main migration tests
  semver.test.ts  # Semver utility tests
  example.test.ts # Progress tracking example test

example/
  db-migrate.ts   # PostgreSQL database migration CLI example
  _db.ts          # Database connection and version storage helpers
  1.0.0/migrate.ts # Example: Create table
  1.1.0/migrate.ts # Example: Add column
  2.0.0/migrate.ts # Example: Create another table

scripts/
  build-npm.ts    # NPM package build script
```

## Dependencies

**Runtime:**
- `@marianmeres/item-collection` - Internal collection management with search

**Dev/Example only:**
- `@std/assert` - Testing assertions
- `@std/cli` - CLI argument parsing
- `@std/fs` - File system operations
- `@std/path` - Path utilities
- `pg` - PostgreSQL client (example only)
- `dotenv` - Environment variables (example only)

## Deno Tasks

```bash
deno task test          # Run tests with watch mode
deno task npm:build     # Build NPM package
deno task npm:publish   # Build and publish to NPM
```

## Usage Patterns

### Basic Migration Setup

```typescript
import { Migrate } from "@marianmeres/migrate";

const migrate = new Migrate({
  getActiveVersion: async (ctx) => { /* read from storage */ },
  setActiveVersion: async (version, ctx) => { /* write to storage */ },
});

migrate.addVersion("1.0.0",
  async (ctx) => { /* upgrade code */ },
  async (ctx) => { /* downgrade code */ }
);

await migrate.up("latest");
await migrate.down("initial");
await migrate.uninstall();
```

### Progress Tracking Pattern

```typescript
const app = new Migrate();
let sequence = 1;

const work = async (thing: string) => {
  const up = () => { /* do work */ };
  const down = () => { /* undo work */ };

  await up(); // Do immediately
  const ver = app.addVersion(`${sequence++}`, up, down);
  await app.setActiveVersion(ver);
};

await work("step1");
await work("step2");
await app.down(); // Undo one step
await app.up("latest"); // Redo all
await app.uninstall(); // Complete removal
```

### Database Migration CLI Pattern

See `example/db-migrate.ts` for a complete PostgreSQL migration example:
- Versions stored in `__migrate__` table
- Migration files in versioned directories (1.0.0/, 1.1.0/, etc.)
- Each exports `up` and `down` functions

## Key Behaviors

1. **Version Normalization:** All versions are normalized to semver format (e.g., "v1" -> "1.0.0")

2. **Upgrade Strategy:** Greedy - goes as far as possible within constraints
   - `up("latest")` - Upgrade to highest version
   - `up("major")` - Upgrade to highest version of next major
   - `up("minor")` - Upgrade within current major
   - `up("patch")` - Upgrade within current minor

3. **Downgrade Strategy:** Conservative - typically one step at a time
   - `down("initial")` - Downgrade to first version (keeps initial)
   - `down("major")` - Downgrade to previous major
   - `down()` - Defaults to one major step down

4. **Uninstall:** Special operation that downgrades past the initial version to undefined

5. **Error Handling:** Throws descriptive errors with migration state context

6. **Searchable Versions:** Internal collection supports search by version/comment

## Code Style

- Uses Deno's built-in formatter with tabs, 90 char line width
- TypeScript with strict-ish settings (no-explicit-any excluded)
- Private fields use `#` prefix
- JSDoc comments on public APIs
